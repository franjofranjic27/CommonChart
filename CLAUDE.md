# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

CommonChart is a generic Helm chart for deploying Kubernetes services. It is published to Docker Hub as an OCI registry artifact and designed to be reused across multiple services without writing custom Helm charts.

- **Chart name**: `generic-chart`
- **Registry**: Docker Hub OCI (`oci://registry-1.docker.io/<DOCKER_USERNAME>/generic-chart`)

## Common Commands

These require `helm` v3 to be installed locally.

```bash
# Validate chart syntax
helm lint .

# Dry-run render to check template output
helm template test-release . --debug

# Package the chart
helm package . --destination ./packaged
```

## CI/CD Workflows

| Workflow | File | Trigger | Purpose |
|----------|------|---------|---------|
| Chart Lint | `.github/workflows/chart-lint.yml` | Push to non-main branches, manual | Runs `helm lint` and `helm template` |
| Chart Release | `.github/workflows/chart-release.yml` | Manual (`workflow_dispatch`) | Packages and pushes chart to Docker Hub OCI |

The release workflow requires `DOCKER_USERNAME` and `DOCKER_TOKEN` repository secrets.

## Architecture

All Kubernetes resources are generated from `templates/` using values from `values.yaml`. Each resource is independently toggleable via `enabled: true/false`.

```
values.yaml
    └── templates/
        ├── deployment.yml   # Main workload (pods, probes, resources, volumes)
        ├── service.yml      # ClusterIP service exposing port 8080
        ├── hpa.yml          # Horizontal autoscaling (CPU-based, 1–3 replicas)
        ├── pdb.yaml         # PodDisruptionBudget (minAvailable: 1)
        └── ingress.yml      # Optional external HTTP routing (disabled by default)
```

**Resource naming and labeling** all derive from `global.appName` in `values.yaml`. This value is used as the `app` label selector across all resources, so it must be consistent.

**Health probes** default to `/api/actuator/health` (Spring Boot Actuator convention):
- `startupProbe`: 12 failures × 10s = up to 120s startup window
- `readinessProbe` and `livenessProbe`: 10s period each

**HPA** uses `autoscaling/v2` API, targeting 80% CPU utilization. The `deployment.yml` must be enabled for HPA to have a target.

## Key Conventions

- Bump `version` in `Chart.yaml` for every chart change before triggering a release.
- The `README.md` is auto-generated by [helm-docs](https://github.com/norwoodj/helm-docs) from `values.yaml` comments — edit the comments in `values.yaml`, not the README directly.
- `values-test.yaml` is currently empty and intended for test-specific overrides.